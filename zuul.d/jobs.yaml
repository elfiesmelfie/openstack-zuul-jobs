# Shared jobs specific to the OpenStack Project
# imports jobs from:
#    https://opendev.org/cgit/openstack/project-config
#    https://opendev.org/cgit/zuul/zuul-jobs

- job:
    name: openstack-zuul-jobs-test-mirror-info
    description: |
      Test the mirror-info role.

      This is meant to be included in a base job, so we inherit from
      base-minimal to make sure it hasn't already run.
    parent: base-minimal
    roles:
      - zuul: zuul/zuul-jobs
    run: tests/base.yaml
    files:
      - ^roles/mirror-info/.*
      - ^tests/.*

- job:
    name: build-openstack-sphinx-docs
    parent: build-sphinx-docs
    nodeset: ubuntu-xenial
    branches: ^(?!driverfixes/).*$
    description: |
      Builds documentation using Sphinx per a previous version of the
      OpenStack PTI and then
      collects the results into the log directory so that they can be
      examined in their published form after a successful build.
      It runs the prepare-docs-for-afs role so that AFS stamp files
      can be examined if desired, and also validates htaccess files
      using the whereto tool.

      This job is obsolete and should not be used anymore since rocky, use
      :zuul:job:`openstack-tox-docs` instead.
    success-url: html/
    required-projects:
      - name: openstack/requirements
      # Add neutron and horizon for the neutron-horizon-hack.
      # TODO(AJaeger) ZOMG DELETE THIS once we neutron-horizon-hack.
      - name: openstack/horizon
      - name: openstack/neutron
    pre-run: playbooks/sphinx-docs/neutron-horizon-hack.yaml
    roles:
      - zuul: zuul/zuul-jobs
    vars:
      constraints_file: '{{ ansible_user_dir }}/src/opendev.org/openstack/requirements/upper-constraints.txt'

- job:
    name: your-readthedocs-job-requires-attention
    parent: base
    description: |
      A placeholder job to warn projects their readthedocs
      post-pipeline jobs are failing and require updating.
    run: playbooks/docs/rtd-warning-job.yaml
    nodeset:
      nodes: []

- job:
    name: tox-py35-on-zuul
    parent: tox-py35
    nodeset: ubuntu-xenial
    description: |
      Run zuul's py35 unittests on patches to zuul-jobs.
    vars:
      zuul_work_dir: src/opendev.org/zuul/zuul
    required-projects:
      - zuul/zuul

- job:
    name: openstack-tox
    abstract: true
    parent: tox
    description: |
      Base job to run tox jobs with OpenStack project specific updates.

      Processing upper-constraints files from openstack/requirements.
    branches: ^(?!stable/(ocata|pike|queens|rocky)).*$
    required-projects:
      - name: openstack/requirements
    vars:
      tox_constraints_file: '{{ ansible_user_dir }}/src/opendev.org/openstack/requirements/upper-constraints.txt'

- job:
    name: openstack-tox
    abstract: true
    parent: tox
    nodeset: ubuntu-xenial
    description: |
      Base job (xenial) to run tox jobs with OpenStack project specific updates.

      Processing upper-constraints files from openstack/requirements.

      This job runs on Xenial for stable/ocata, pike, queens and rocky. This
      job is prepared to make sure all stable branches before stable/stein will
      keep running on xenial.
    branches:
      - stable/ocata
      - stable/pike
      - stable/queens
      - stable/rocky
    required-projects:
      - name: openstack/requirements
    vars:
      tox_constraints_file: '{{ ansible_user_dir }}/src/opendev.org/openstack/requirements/upper-constraints.txt'

- job:
    name: openstack-tox-with-sudo
    parent: openstack-tox
    description: |
      Job to run tox for tests with OpenStack project specific
      settings such as constraints but without sudo access being revoked.
    run: playbooks/tox-with-sudo/run.yaml

- job:
    name: openstack-tox-py27
    parent: openstack-tox
    timeout: 2400
    description: |
      Run unit tests for an OpenStack Python project under cPython version 2.7.

      Uses tox with the ``py27`` environment.
    irrelevant-files: &common-irrelevant-files
      - ^.*\.rst$
      - ^api-ref/.*$
      - ^doc/.*$
      - ^releasenotes/.*$
      - ^deliverables/.*$
    vars:
      tox_envlist: py27
      bindep_profile: test py27

- job:
    name: openstack-tox-py35
    parent: openstack-tox
    nodeset: ubuntu-xenial
    branches: ^(?!driverfixes/).*$
    timeout: 2400
    description: |
      Run unit tests for an OpenStack project under cPython version 3.5.

      Uses tox with the ``py35`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: py35
      bindep_profile: test py35

- job:
    name: openstack-tox-py36
    parent: openstack-tox
    nodeset: ubuntu-bionic
    timeout: 2400
    description: |

      Run unit tests for an OpenStack Python project under cPython
      version 3.6.

      Uses tox with the ``py36`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: py36
      bindep_profile: test py36

- job:
    name: openstack-tox-py37
    parent: openstack-tox
    nodeset: ubuntu-bionic
    timeout: 2400
    description: |

      Run unit tests for an OpenStack Python project under cPython
      version 3.7.

      Uses tox with the ``py37`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: py37
      bindep_profile: test py37
      python_version: 3.7

- job:
    name: openstack-tox-pypy
    parent: openstack-tox
    description: |
      Run unit tests for an OpenStack Python project under PyPy.

      Uses tox with the ``pypy`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: pypy
      bindep_profile: test pypy

- job:
    name: openstack-tox-linters
    parent: openstack-tox
    description: |
      Runs code linting tests.

      Uses tox with the ``linters`` environment.
    vars:
      tox_envlist: linters
      bindep_profile: test linters

- job:
    name: openstack-tox-molecule
    parent: tox-molecule
    description: |
      Runs molecule to test Ansible roles.

      Uses tox with the ``molecule`` environment.
    success-url: "tox/reports.html"
    failure-url: "tox/reports.html"
    vars:
      bindep_profile: test molecule

- job:
    name: openstack-tox-pep8
    parent: openstack-tox
    description: |
      Runs code pep8 tests.

      Uses tox with the ``pep8`` environment.
    vars:
      tox_envlist: pep8
      bindep_profile: test pep8
      test_setup_skip: true

- job:
    name: openstack-tox-cover
    parent: tox-cover
    description: |
      Run code coverage tests.

      Uses tox with the ``cover`` environment.
    branches: ^(?!stable/(ocata|pike|queens|rocky)).*$
    required-projects:
      - name: openstack/requirements
    irrelevant-files: *common-irrelevant-files
    success-url: cover/
    vars:
      tox_constraints_file: '{{ ansible_user_dir }}/src/opendev.org/openstack/requirements/upper-constraints.txt'
    timeout: 3000

- job:
    name: openstack-tox-cover
    parent: tox-cover
    description: |
      Run code coverage tests (Xenial).

      Uses tox with the ``cover`` environment.

      This job runs on Xenial for stable/ocata, pike, queens and rocky. This
      job is prepared to make sure all stable branches before stable/stein will
      keep running on xenial.
    nodeset: ubuntu-xenial
    required-projects:
      - name: openstack/requirements
    irrelevant-files: *common-irrelevant-files
    success-url: cover/
    vars:
      tox_constraints_file: '{{ ansible_user_dir }}/src/opendev.org/openstack/requirements/upper-constraints.txt'
    timeout: 3000
    branches:
      - stable/ocata
      - stable/pike
      - stable/queens
      - stable/rocky

- job:
    name: openstack-tox-bashate
    parent: openstack-tox
    description: |
      Run bashate tests.

      Uses tox with the ``bashate`` environment.
    vars:
      tox_envlist: bashate

- job:
    name: openstack-tox-build
    parent: openstack-tox
    description: |
      Run build tests.

      Uses tox with the ``build`` environment.
    vars:
      tox_envlist: build

- job:
    name: openstack-tox-functional
    parent: openstack-tox
    description: |
      Run tox-based functional tests for an OpenStack Python project.

      Uses tox with the ``functional`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: functional

- job:
    name: openstack-tox-functional-with-sudo
    parent: openstack-tox-with-sudo
    description: |
      Run tox-based functional tests for an OpenStack Python project.

      Uses tox with the ``functional`` environment.
      Sudo access is not revoked.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: functional

- job:
    name: openstack-tox-functional-py35
    parent: openstack-tox
    nodeset: ubuntu-xenial
    description: |
      Run tox-based functional tests for an OpenStack Python project
      under cPython version 3.5..

      Uses tox with the ``functional-py35`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: functional-py35

- job:
    name: openstack-tox-functional-py36
    parent: openstack-tox
    nodeset: ubuntu-bionic
    description: |
      Run tox-based functional tests for an OpenStack Python project
      under cPython version 3.6.

      Uses tox with the ``functional-py36`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: functional-py36

- job:
    name: openstack-tox-functional-py37
    parent: openstack-tox
    nodeset: ubuntu-bionic
    description: |
      Run tox-based functional tests for an OpenStack Python project
      under cPython version 3.7.

      Uses tox with the ``functional-py37`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: functional-py37
      python_version: 3.7

- job:
    name: openstack-tox-validate
    parent: openstack-tox
    description: |
      Run validate tests.

      Uses tox with the ``validate`` environment.
    vars:
      tox_envlist: validate

- job:
    name: openstack-tox-pylint
    parent: openstack-tox
    description: |
      Runs pylint tests.

      Uses tox with the ``pylint`` environment.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: pylint

- job:
    name: openstack-tox-compare-cover
    parent: openstack-tox
    # NOTE(sambetts) This job runs the full UTs twice to compare the coverage
    # pre-and-post a patch so requires longer to run.
    timeout: 4500
    description: |
      Run coverage comparison tests.

      Uses tox with the ``compare-cover`` environment.
    vars:
      tox_envlist: compare-cover

- job:
    name: openstack-tox-snap-with-sudo
    parent: openstack-tox-with-sudo
    description: |
      Run tox-based functional tests for an OpenStack Python project.

      Uses tox with the ``snap`` environment.
      Sudo access is not revoked.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: snap

- job:
    name: openstack-tox-docs
    parent: tox-docs
    description: |
      Run documentation build.

      Uses tox with the ``docs`` environment.
    branches: ^(?!stable/(ocata|pike|queens|rocky)).*$
    required-projects:
      - name: openstack/requirements
    vars:
      tox_constraints_file: '{{ ansible_user_dir }}/src/opendev.org/openstack/requirements/upper-constraints.txt'
      tox_envlist: docs
      bindep_profile: compile doc
    success-url: html/

- job:
    name: openstack-tox-docs
    parent: tox-docs
    description: |
      Run documentation build (xenial).

      Uses tox with the ``docs`` environment.

      This job runs on Xenial for stable/ocata, pike, queens and rocky. This
      job is prepared to make sure all stable branches before stable/stein will
      keep running on xenial.
    required-projects:
      - name: openstack/requirements
    vars:
      tox_constraints_file: '{{ ansible_user_dir }}/src/opendev.org/openstack/requirements/upper-constraints.txt'
      tox_envlist: docs
      bindep_profile: compile doc
    success-url: html/
    nodeset: ubuntu-xenial
    branches:
      - stable/ocata
      - stable/pike
      - stable/queens
      - stable/rocky

- job:
    name: openstack-tox-with-oslo-master-base
    parent: openstack-tox-py27
    timeout: 3000
    description: |
      This job installs all oslo libraries from source and tests that the
      unit tests of the tested project work.
    required-projects:
      - openstack/automaton
      - openstack/debtcollector
      - openstack/futurist
      - openstack/osprofiler
      - openstack/oslo.cache
      - openstack/oslo.concurrency
      - openstack/oslo.config
      - openstack/oslo.context
      - openstack/oslo.db
      - openstack/oslo.i18n
      - openstack/oslo.log
      - openstack/oslo.messaging
      - openstack/oslo.middleware
      - openstack/oslo.policy
      - openstack/oslo.privsep
      - openstack/oslo.reports
      - openstack/oslo.rootwrap
      - openstack/oslo.serialization
      - openstack/oslo.service
      - openstack/oslo.utils
      - openstack/oslo.versionedobjects
      - openstack/oslo.vmware
      - openstack/oslotest
      - openstack/pycadf
      - openstack/stevedore
      - openstack/taskflow
      - openstack/tooz
      - openstack/pbr
    vars:
      tox_install_siblings: true

- job:
    name: openstack-tox-py27-with-oslo-master
    parent: openstack-tox-with-oslo-master-base
    description: |
      This job installs all oslo libraries from source and tests that the
      unit tests of the tested project work.

      It uses the tox ``py27`` environment.

      The job is normally run in a periodic pipeline, it is configured
      to run on the master branch.
    branches: master
    vars:
      tox_envlist: py27
      bindep_profile: test py27

- job:
    name: openstack-tox-py36-with-oslo-master
    parent: openstack-tox-with-oslo-master-base
    nodeset: ubuntu-bionic
    description: |
      This job installs all oslo libraries from source and tests that the
      unit tests of the tested project work.

      It uses the tox ``py36`` environment.

      The job is normally run in a periodic pipeline, it is configured
      to run on the master branch.
    branches: master
    vars:
      tox_envlist: py36
      bindep_profile: test py36

- job:
    name: openstack-tox-py36-with-neutron-lib-master
    parent: openstack-tox-py36
    timeout: 3000
    description: |
      This job installs neutron-lib from source and tests that the
      unit tests of the tested project work.

      It uses the tox ``py36`` environment.

      The job is normally run in a periodic pipeline, it is configured
      to run on the master branch.
    branches: master
    required-projects:
      - openstack/neutron
      - openstack/neutron-lib
    vars:
      tox_install_siblings: true

- job:
    name: openstack-tox-py36-with-ovsdbapp-master
    parent: openstack-tox-py36
    timeout: 3000
    description: |
      This job installs ovsdbapp from source and tests that the
      unit tests of the tested project work.

      It uses the tox ``py36`` environment.

      The job is normally run in a periodic pipeline, it is configured
      to run on the master branch.
    branches: master
    required-projects:
      - openstack/ovsdbapp
    vars:
      tox_install_siblings: true

- job:
    name: openstack-tox-lower-constraints
    parent: openstack-tox
    branches: ^(?!driverfixes/).*$
    timeout: 2400
    description: |
      Run unit tests using the lower constraints.

      Uses tox with the ``lower-constraints`` environment,
      which should be configured to use Python 3 by default
      unless the project does not support Python 3.
    irrelevant-files: *common-irrelevant-files
    vars:
      tox_envlist: lower-constraints
      bindep_profile: test py35 py36

- job:
    name: build-openstack-puppet-tarball
    description: |
      Build a puppet tarball but do not upload it anywhere.
    pre-run: playbooks/puppet-tarball/pre.yaml
    run: playbooks/puppet-tarball/run.yaml
    files: ^metadata.json$

- job:
    name: publish-openstack-puppet-branch-tarball
    parent: publish-openstack-artifacts
    description: |
      Publish the results of the puppet-tarball job to tarballs.openstack.org.
    pre-run: playbooks/puppet-tarball/pre.yaml
    run: playbooks/puppet-tarball/run.yaml
    post-run: playbooks/puppet-branch-tarball/post.yaml

- job:
    name: publish-openstack-javascript-tarball
    parent: publish-openstack-artifacts
    description: |
      Build and publish source tarball for a Javascript project.

      Responds to these variables:

      .. zuul:jobvar:: node_version
         :default: 6

        The version of Node to use.

      .. zuul:jobvar: zuul_work_dir
         :default: {{ zuul.project.src_dir }}

        Path to operate in.
    pre-run: playbooks/javascript/pre.yaml
    run: playbooks/javascript/tarball.yaml
    post-run:
      - playbooks/javascript/post.yaml
      - playbooks/javascript/post-tarball.yaml

- job:
    name: announce-release
    description: Send a release announcement after publishing a project
    pre-run: playbooks/release/pre.yaml
    run: playbooks/release/announce.yaml
    required-projects:
      - openstack/releases

- job:
    name: xstatic-check-version
    description: Check version used by xstatic packages
    run: playbooks/xstatic/check-version.yaml

- job:
    name: build-openstack-releasenotes
    branches: ^(?!driverfixes/).*$
    parent: build-reno-releasenotes
    description: |
      Build releasenotes, with optional translation support, using reno.
    # Building translated releasenotes can take long for large repositories
    timeout: 3600
    required-projects:
      - name: openstack/requirements
    vars:
      constraints_file: '{{ ansible_user_dir }}/src/opendev.org/openstack/requirements/upper-constraints.txt'

- job:
    name: build-openstack-api-ref
    parent: opendev-tox-docs
    description: |
      Build api-ref document. This is only run on master branch of a
      project.
    timeout: 1800
    vars:
      sphinx_build_dir: api-ref/build
      tox_envlist: api-ref
    # We only publish the master branch, so no need to run
    # for changes on other branches.
    branches: master
    files:
      - ^os_api_ref/.*
      - ^api-ref/.*
      - ^doc/api_samples/.*
      - bindep.txt
      - doc/requirements.txt
      - test-requirements.txt
      - tox.ini

- job:
    name: build-openstack-api-guide
    parent: opendev-tox-docs
    description: |
      Build api-guide document. This is only run for changes on master
      branch of a project.
    vars:
      sphinx_build_dir: api-guide/build
      tox_envlist: api-guide
    # We only publish the master branch, so no need to run
    # for changes on other branches.
    branches: master
    files:
      - ^api-guide/.*
      - bindep.txt
      - doc/requirements.txt
      - test-requirements.txt
      - tox.ini

- job:
    name: build-openstack-deploy-guide
    parent: openstack-tox-docs
    description: |
      Build deploy-guide document.
    vars:
      sphinx_build_dir: deploy-guide/build
      tox_envlist: deploy-guide
    files:
      - ^deploy-guide/.*
      - bindep.txt
      - doc/requirements.txt
      - test-requirements.txt
      - tox.ini

- job:
    name: build-openstack-install-guide
    parent: build-openstack-sphinx-docs
    description: |
      Build install-guide document.
    vars:
      sphinx_build_dir: install-guide/build
      sphinx_source_dir: install-guide/source
    # This job runs only pre-pike, with pike the documents have been
    # integrated into normal builds.
    branches:
      - stable/newton
      - stable/ocata
    files:
      - ^install-guide/.*
      - bindep.txt
      - doc/requirements.txt
      - test-requirements.txt

- job:
    name: legacy-base
    abstract: true
    description: |
      Base job (xenial) for autoconverted legacy jobs

      This job runs on Xenial and this is for stable/ocata, pike, queens
      and rocky. This job is prepared to make sure all stable branches
      before stable/stein will keep running on xenial.
    pre-run: playbooks/legacy/pre.yaml
    nodeset: legacy-ubuntu-xenial
    vars:
      bindep_fallback: /usr/local/bindep-fallback/bindep-fallback.txt
    branches:
      - stable/ocata
      - stable/pike
      - stable/queens
      - stable/rocky

- job:
    name: legacy-base
    abstract: true
    description: |
      Base job (bionic) for autoconverted legacy jobs

      This job runs on Bionic from stable/stein on.
    pre-run: playbooks/legacy/pre.yaml
    vars:
      bindep_fallback: /usr/local/bindep-fallback/bindep-fallback.txt
    branches: ^(?!stable/(ocata|pike|queens|rocky)).*$
    nodeset: legacy-ubuntu-bionic

- job:
    name: legacy-dsvm-base
    abstract: true
    description: |
      Base job (xenial) for autoconverted legacy devstack-gate jobs

      This job runs devstack-gate with as few changes as possible and
      may be used by jobs which have been automatically converted as
      part of the migration to Zuul v3. This job runs on Xenial for
      stable/ocata, pike, queens and rocky. This job is prepared to
      make sure all stable branches before stable/stein will keep
      running on xenial.
    nodeset: devstack-single-node
    branches:
      - stable/ocata
      - stable/pike
      - stable/queens
      - stable/rocky
    pre-run: playbooks/legacy/pre.yaml
    required-projects:
      - openstack/devstack
      - openstack/devstack-gate
      - openstack/tripleo-ci
      - openstack/ceilometer
      - openstack/ceilometermiddleware
      - openstack/cinder
      - openstack/django_openstack_auth
      - openstack/glance
      - openstack/glance_store
      - openstack/heat
      - openstack/heat-cfntools
      - openstack/heat-templates
      - openstack/horizon
      - openstack/keystone
      - openstack/keystoneauth
      - openstack/keystonemiddleware
      - openstack/manila
      - openstack/manila-ui
      - openstack/neutron
      - openstack/neutron-fwaas
      - openstack/neutron-lbaas
      - openstack/neutron-vpnaas
      - openstack/nova
      - openstack/octavia
      - openstack/os-apply-config
      - openstack/os-brick
      - openstack/os-client-config
      - openstack/os-collect-config
      - openstack/os-net-config
      - openstack/os-refresh-config
      - openstack/osc-lib
      # NOTE(mriedem): The openstack/placement repo is new in Stein and will
      # be ignored on stable branches before Stein.
      - openstack/placement
      - openstack/requirements
      - openstack/swift
      - openstack/tempest
      - openstack/tripleo-heat-templates
      - openstack/tripleo-image-elements
      - openstack/zaqar

- job:
    name: legacy-dsvm-base
    abstract: true
    description: |
      Base job (bionic) for autoconverted legacy devstack-gate jobs

      This job runs devstack-gate with as few changes as possible and
      may be used by jobs which have been automatically converted as
      part of the migration to Zuul v3. This job runs on Bionic from
      stable/stein on.
    branches: ^(?!stable/(ocata|pike|queens|rocky)).*$
    nodeset: legacy-ubuntu-bionic
    pre-run: playbooks/legacy/pre.yaml
    required-projects:
      - openstack/devstack
      - openstack/devstack-gate
      - openstack/tripleo-ci
      - openstack/ceilometer
      - openstack/ceilometermiddleware
      - openstack/cinder
      - openstack/django_openstack_auth
      - openstack/glance
      - openstack/glance_store
      - openstack/heat
      - openstack/heat-cfntools
      - openstack/heat-templates
      - openstack/horizon
      - openstack/keystone
      - openstack/keystoneauth
      - openstack/keystonemiddleware
      - openstack/manila
      - openstack/manila-ui
      - openstack/neutron
      - openstack/neutron-fwaas
      - openstack/neutron-lbaas
      - openstack/neutron-vpnaas
      - openstack/nova
      - openstack/octavia
      - openstack/os-apply-config
      - openstack/os-brick
      - openstack/os-client-config
      - openstack/os-collect-config
      - openstack/os-net-config
      - openstack/os-refresh-config
      - openstack/osc-lib
      # NOTE(mriedem): The openstack/placement repo is new in Stein and will
      # be ignored on stable branches before Stein.
      - openstack/placement
      - openstack/requirements
      - openstack/swift
      - openstack/tempest
      - openstack/tripleo-heat-templates
      - openstack/tripleo-image-elements
      - openstack/zaqar

- job:
    name: legacy-dsvm-base-multinode
    abstract: true
    parent: legacy-dsvm-base
    description: |
      Base job (xenial) for multinode devstack jobs.

      Will setup firewall rules on all the nodes allowing them to talk to
      each other. This job runs on Xenial for stable/ocata, pike, queens
      and rocky. This job is prepared to make sure all stable branches
      before stable/stein will keep running on xenial.

    roles:
      - zuul: zuul/zuul-jobs
    pre-run: playbooks/legacy/multinode-networking/pre.yaml
    nodeset: legacy-ubuntu-xenial-2-node
    branches:
      - stable/ocata
      - stable/pike
      - stable/queens
      - stable/rocky

- job:
    name: legacy-dsvm-base-multinode
    abstract: true
    parent: legacy-dsvm-base
    description: |
      Base job (bionic) for multinode devstack jobs.

      Will setup firewall rules on all the nodes allowing them to talk to
      each other. This job runs on Bionic from stable/stein on.
    roles:
      - zuul: zuul/zuul-jobs
    pre-run: playbooks/legacy/multinode-networking/pre.yaml
    branches: ^(?!stable/(ocata|pike|queens|rocky)).*$
    nodeset: legacy-ubuntu-bionic-2-node

- job:
    name: legacy-puppet-openstack-integration
    abstract: true
    description: |
      Base job for autoconverted legacy puppet-openstack-integration

      This job runs provides the base required projects for
      puppet-openstack-integration jobs.
    nodeset: devstack-single-node
    pre-run: playbooks/legacy/pre.yaml
    required-projects:
      - openstack/puppet-aodh
      - openstack/puppet-barbican
      - openstack/puppet-ceilometer
      - openstack/puppet-ceph
      - openstack/puppet-cinder
      - openstack/puppet-cloudkitty
      - openstack/puppet-congress
      - openstack/puppet-designate
      - openstack/puppet-ec2api
      - openstack/puppet-glance
      - openstack/puppet-gnocchi
      - openstack/puppet-heat
      - openstack/puppet-horizon
      - openstack/puppet-ironic
      - openstack/puppet-keystone
      - openstack/puppet-manila
      - openstack/puppet-mistral
      - x/puppet-modulesync-configs
      - openstack/puppet-monasca
      - openstack/puppet-murano
      - openstack/puppet-neutron
      - openstack/puppet-nova
      - openstack/puppet-octavia
      - openstack/puppet-openstack-cookiecutter
      - openstack/puppet-openstack-integration
      - openstack/puppet-openstack_extras
      - openstack/puppet-openstacklib
      - openstack/puppet-oslo
      - openstack/puppet-ovn
      - openstack/puppet-panko
      - openstack/puppet-qdr
      - openstack/puppet-sahara
      - openstack/puppet-swift
      - openstack/puppet-tacker
      - openstack/puppet-tempest
      - openstack/puppet-trove
      - openstack/puppet-vswitch
      - openstack/puppet-vitrage
      - openstack/puppet-watcher
      - openstack/puppet-zaqar
      - openstack/tempest-horizon

- job:
    name: legacy-publish-openstack-artifacts
    abstract: true
    parent: publish-openstack-artifacts
    description: |
      Base job (xenial) for autoconverted legacy jobs that publish artifacts

      This job runs on Xenial for stable/ocata, pike, queens
      and rocky. This job is prepared to make sure all stable branches
      before stable/stein will keep running on xenial.
    nodeset: devstack-single-node
    pre-run: playbooks/legacy/pre.yaml
    branches:
      - stable/ocata
      - stable/pike
      - stable/queens
      - stable/rocky

- job:
    name: legacy-publish-openstack-artifacts
    abstract: true
    parent: publish-openstack-artifacts
    description: |
      Base job (bionic) for autoconverted legacy jobs that publish artifacts.

      This job runs on Bionic from stable/stein on.
    branches: ^(?!stable/(ocata|pike|queens|rocky)).*$
    nodeset: legacy-ubuntu-bionic
    pre-run: playbooks/legacy/pre.yaml


- job:
    name: project-config-gerrit
    parent: tox
    description: |
      Runs checks on gerrit-related configuration.  Uses ``gerrit``
      tox env.
    vars:
      tox_envlist: gerrit
    files:
      - ^gerrit/acls/.*$
      - bindep.txt
      - tools/check_valid_gerrit_projects.py
      - gerrit/projects.yaml
      - other-requirements.txt
      - tools/check_projects_yaml_alphabetized.sh
      - tools/check_valid_gerrit_config.sh
      - tox.ini
      - zuul/main.yaml

- job:
    name: project-config-grafyaml
    parent: tox
    description: |
      Runs checks on grafyaml configuration with the ``grafyaml`` tox
      env.
    vars:
      tox_envlist: grafyaml
      tox_environment:
        GRAFYAML_SRC: "{{ ansible_user_dir }}/{{ zuul.projects['opendev.org/opendev/grafyaml'].src_dir }}"
    required-projects:
      - opendev/grafyaml
    files:
      - ^grafana/.*$
      - bindep.txt
      - other-requirements.txt
      - tox.ini

- job:
    name: project-config-irc-access
    parent: tox
    description: |
      Runs checks on IRC configuration with the ``irc`` tox
      env.
    vars:
      tox_envlist: irc
    files:
      - bindep.txt
      - accessbot/channels.yaml
      - gerritbot/channels.yaml
      - other-requirements.txt
      - tools/check_irc_access.py
      - tools/check_channels_yaml.sh
      - tools/irc_tests.py
      - tools/normalize_channels_yaml.py
      - tools/projectconfig_yamllib.py
      - tox.ini

- job:
    name: project-config-nodepool
    parent: tox
    description: |
      Runs checks on nodepool configuration with the ``nodepool`` tox
      env.
    vars:
      tox_envlist: nodepool
    required-projects:
      - zuul/nodepool
    files:
      - ^nodepool/nodepool.yaml
      - ^nodepool/nl.*yaml$
      - bindep.txt
      - other-requirements.txt
      - tox.ini

- job:
    name: build-openstack-specs-site
    parent: tox
    description: |
      Generates the index page of http://specs.openstack.org/.
    vars:
      tox_envlist: specs
    files:
      - bindep.txt
      - specs/.*
      - other-requirements.txt
      - tox.ini

- job:
    name: project-config-dib
    parent: tox
    description: |
      Runs diskimage-builder on all elements in project-config.  Uses
      the ``dib`` tox env.
    vars:
      tox_envlist: dib
    files:
      - ^nodepool/elements/.*$
      - bindep.txt
      - other-requirements.txt
      - tox.ini

- job:
    name: project-config-infra-docs-index
    parent: tox
    description: |
      Generates the index page for https://docs.openstack.org/infra/.
    vars:
      tox_envlist: infra-docs
    files:
      - bindep.txt
      - docs-site/.*
      - other-requirements.txt
      - tox.ini

- job:
    name: project-config-build-openafs-centos
    description: |
      There are no official builds for AFS on Centos 7, hence
      we build our own and publish them to tarballs.openstack.org
      for our centos hosts that need access to the mirror to
      consume.
    parent: publish-openstack-artifacts
    run: playbooks/package-afs-centos/run.yaml
    post-run: playbooks/package-afs-centos/post.yaml
    nodeset: centos-7

- job:
    name: openstack-zuul-jobs-linters
    parent: tox
    description: |
      This job runs against base-jobs, project-config, openstack-zuul-jobs
      and zuul-jobs so we can properly lint our ansible playbooks / roles.
    required-projects:
      - opendev/base-jobs
      - openstack/openstack-zuul-jobs
      - openstack/project-config
      - opendev/system-config
      - zuul/zuul-jobs
      - zuul/zuul
    vars:
      tox_envlist: linters
      tox_environment:
        ANSIBLE_ROLES_PATH: ~/src/opendev.org/opendev/base-jobs/roles:~/src/opendev.org/zuul/zuul-jobs/roles:~/src/opendev.org/openstack/openstack-zuul-jobs/roles:~/src/opendev.org/openstack/project-config/roles:~/src/opendev.org/opendev/system-config/roles

- job:
    name: infra-puppet-apply-base
    # Required to install z-c for puppet module installs.
    parent: legacy-base
    timeout: 1800
    required-projects:
      - opendev/system-config
      - opendev/ansible-role-puppet
      - opendev/puppet-accessbot
      - opendev/puppet-ansible
      - opendev/puppet-apparmor
      - opendev/puppet-askbot
      - opendev/puppet-asterisk
      - opendev/puppet-bandersnatch
      - opendev/puppet-bugdaystats
      - opendev/puppet-bup
      - opendev/puppet-cgit
      - opendev/puppet-ciwatch
      - opendev/puppet-diskimage_builder
      - opendev/puppet-drupal
      - opendev/puppet-elastic_recheck
      - opendev/puppet-elasticsearch
      - opendev/puppet-ethercalc
      - opendev/puppet-etherpad_lite
      - opendev/puppet-exim
      - opendev/puppet-germqtt
      - opendev/puppet-gerrit
      - opendev/puppet-gerritbot
      - opendev/puppet-github
      - opendev/puppet-grafyaml
      - opendev/puppet-graphite
      - opendev/puppet-haveged
      - opendev/puppet-hound
      - opendev/puppet-httpd
      - opendev/puppet-infracloud
      - opendev/puppet-infra-cookiecutter
      - opendev/puppet-ipsilon
      - opendev/puppet-iptables
      - opendev/puppet-jeepyb
      - opendev/puppet-jenkins
      - opendev/puppet-kerberos
      - opendev/puppet-kibana
      - opendev/puppet-lodgeit
      - opendev/puppet-log_processor
      - opendev/puppet-logrotate
      - opendev/puppet-logstash
      - opendev/puppet-lpmqtt
      - opendev/puppet-mailman
      - opendev/puppet-mediawiki
      - opendev/puppet-meetbot
      - opendev/puppet-mosquitto
      - opendev/puppet-mqtt_statsd
      - opendev/puppet-mysql_backup
      - opendev/puppet-nodepool
      - opendev/puppet-openafs
      - opendev/puppet-openstackci
      - opendev/puppet-openstack_health
      - opendev/puppet-openstackid
      - opendev/puppet-openstack_infra_spec_helper
      - opendev/puppet-os_client_config
      - opendev/puppet-packagekit
      - opendev/puppet-pgsql_backup
      - opendev/puppet-phabricator
      - opendev/puppet-pip
      - opendev/puppet-planet
      - opendev/puppet-project_config
      - opendev/puppet-ptgbot
      - opendev/puppet-puppet
      - opendev/puppet-redis
      - opendev/puppet-refstack
      - opendev/puppet-reviewday
      - opendev/puppet-simpleproxy
      - opendev/puppet-snmpd
      - opendev/puppet-ssh
      - opendev/puppet-ssl_cert_check
      - opendev/puppet-statusbot
      - opendev/puppet-storyboard
      - opendev/puppet-subunit2sql
      - opendev/puppet-sudoers
      - opendev/puppet-tmpreaper
      - opendev/puppet-translation_checksite
      - opendev/puppet-ulimit
      - opendev/puppet-unattended_upgrades
      - opendev/puppet-unbound
      - opendev/puppet-user
      - opendev/puppet-vcsrepo
      - opendev/puppet-yum
      - opendev/puppet-zanata
      - opendev/puppet-zuul
    pre-run: playbooks/infra-puppet-apply/pre.yaml
    run: playbooks/infra-puppet-apply/run.yaml
    post-run: playbooks/infra-puppet-apply/post.yaml

- job:
    name: infra-puppet-apply-4-ubuntu-xenial
    parent: infra-puppet-apply-base
    nodeset: ubuntu-xenial
    vars:
      puppet_version: 4

- job:
    name: puppet-beaker-rspec-infra
    parent: legacy-base
    description: |
      Base job for beaker-rspec tests for Infra's puppet modules.
    nodeset: devstack-single-node
    run: playbooks/infra-puppet-beaker-rspec/run.yaml
    vars:
      nodeset: nodepool-xenial
      project_src_dir: "{{ zuul.project.src_dir }}"
    timeout: 3600
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^test-requirements.txt$
    required-projects:
      - openstack/project-config
      - opendev/system-config
      - opendev/puppet-openstack_infra_spec_helper
      - opendev/puppet-bugdaystats
      - opendev/puppet-mysql_backup
      - opendev/puppet-openstackci
      - opendev/puppet-zuul
      - opendev/puppet-mqtt_statsd
      - opendev/puppet-meetbot
      - opendev/puppet-hound
      - opendev/puppet-pip
      - opendev/puppet-os_client_config
      - opendev/puppet-openstackid
      - opendev/puppet-bandersnatch
      - opendev/puppet-project_config
      - opendev/puppet-grafyaml
      - opendev/puppet-refstack
      - opendev/puppet-github
      - opendev/puppet-ethercalc
      - opendev/puppet-unattended_upgrades
      - opendev/puppet-openafs
      - opendev/puppet-httpd
      - opendev/puppet-drupal
      - opendev/puppet-subunit2sql
      - opendev/puppet-reviewday
      - opendev/puppet-kibana
      - opendev/puppet-redis
      - opendev/puppet-phabricator
      - opendev/puppet-ssl_cert_check
      - opendev/puppet-lpmqtt
      - opendev/puppet-germqtt
      - opendev/puppet-cgit
      - opendev/puppet-packagekit
      - opendev/puppet-haveged
      - opendev/puppet-graphite
      - opendev/puppet-diskimage_builder
      - opendev/puppet-sudoers
      - opendev/puppet-zanata
      - opendev/puppet-logstash
      - opendev/puppet-gerritbot
      - opendev/puppet-asterisk
      - opendev/puppet-statusbot
      - opendev/puppet-gerrit
      - opendev/puppet-mediawiki
      - opendev/puppet-mailman
      - opendev/puppet-exim
      - opendev/puppet-tmpreaper
      - opendev/puppet-elastic_recheck
      - opendev/puppet-ulimit
      - opendev/puppet-planet
      - opendev/puppet-nodepool
      - opendev/puppet-logrotate
      - opendev/puppet-infracloud
      - opendev/puppet-elasticsearch
      - opendev/puppet-unbound
      - opendev/puppet-storyboard
      - opendev/puppet-openstack_health
      - opendev/puppet-kerberos
      - opendev/puppet-askbot
      - opendev/puppet-log_processor
      - opendev/puppet-simpleproxy
      - opendev/puppet-iptables
      - opendev/puppet-lodgeit
      - opendev/puppet-etherpad_lite
      - opendev/puppet-mosquitto
      - opendev/puppet-bup
      - opendev/puppet-pgsql_backup
      - opendev/puppet-ansible
      - opendev/puppet-ssh
      - opendev/puppet-snmpd
      - opendev/puppet-user
      - opendev/puppet-jeepyb
      - opendev/puppet-accessbot
      - opendev/puppet-ptgbot
      - opendev/puppet-jenkins
      - opendev/puppet-vcsrepo

- job:
    name: puppet-beaker-rspec-puppet-4-infra
    parent: puppet-beaker-rspec-infra
    description: |
      Run beaker-rspec functional tests with puppet 4 on Ubuntu Xenial.
    vars:
      puppet_version: 4

- job:
    name: puppet-beaker-rspec-puppet-4-centos-7-infra
    parent: puppet-beaker-rspec-infra
    nodeset: centos-7
    description: |
      Run beaker-rspec functional tests with puppet 4 on CentOS 7.
    vars:
      nodeset: nodepool-centos7
      puppet_version: 4

- job:
    name: openstackci-beaker-puppet-4
    parent: puppet-beaker-rspec-infra
    description: |
      Run beaker-rspec functional tests with puppet 4 on Ubuntu Xenial for the
      puppet-openstackci module.
    vars:
      project_src_dir: "{{ zuul.projects['opendev.org/opendev/puppet-openstackci'].src_dir }}"
      puppet_version: 4

- job:
    name: ansible-role-functional-base
    abstract: true
    parent: tox
    description: |
      Run functional functional tests for ansible-role projects.

      Uses tox with the ``functional`` environment.
    pre-run: playbooks/ansible-role-functional/pre.yaml
    run: playbooks/tox-with-sudo/run.yaml
    vars:
      tox_envlist: functional

- job:
    name: ansible-role-functional-centos-7
    parent: ansible-role-functional-base
    nodeset: centos-7

- job:
    name: ansible-role-functional-ubuntu-xenial
    parent: ansible-role-functional-base

- job:
    name: golang-base
    parent: unittests
    abstract: true
    description: |
      Base job for golang tests.
    pre-run: playbooks/golang/pre.yaml
    run: playbooks/golang/run.yaml

- job:
    name: golang-fmt
    parent: golang-base
    description: |
      Run golang fmt test.

      This uses the make target ``fmt``.
    vars:
      golang_target: "fmt"

- job:
    name: golang-unit
    parent: golang-base
    description: |
      Run golang unit test.

      This uses the make target ``test``.
    vars:
      golang_target: "test"

- job:
    name: kata-runsh
    parent: base
    description: |
      Run kata's setup.sh and run.sh CI scripts.
    pre-run: playbooks/kata-runsh/pre.yaml
    run: playbooks/kata-runsh/run.yaml
    post-run: playbooks/kata-runsh/post.yaml
    timeout: 7200
    nodeset:
      nodes:
        - name: ubuntu-xenial
          label: ubuntu-xenial-vexxhost

- job:
    name: kata-runsh-fedora-28
    parent: kata-runsh
    nodeset:
      nodes:
        - name: fedora-28
          label: fedora-28-vexxhost

- job:
    name: openstack-infra-extra-integration
    description: |
      Runs non-base roles that are used within various jobs to prevent
      regressions.  As opposed to base roles, these may run in a
      limited set of environments or have other simplifying
      assumptions.
    abstract: true
    protected: true
    parent: base
    required-projects:
      - openstack/project-config
    roles:
      - zuul: zuul/zuul-jobs
    run: tests/extra.yaml
    files:
      - ^zuul.d/*
      - ^roles/prepare-zanata-client/.*
      - ^tests/.*

# NOTE(ianw): This test restricted to the two node types these roles
# run on in the gate.
- job:
    name: openstack-infra-extra-integration-xenial
    parent: openstack-infra-extra-integration
    nodeset: ubuntu-xenial

- job:
    name: openstack-infra-extra-integration-bionic
    parent: openstack-infra-extra-integration
    nodeset: ubuntu-bionic
