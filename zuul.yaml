# Shared jobs specific to the OpenStack Project
# imports jobs from:
#    https://git.openstack.org/cgit/openstack-infra/project-config
#    https://git.openstack.org/cgit/openstack-infra/zuul-jobs

- job:
    name: openstack-doc-build
    parent: tox-docs
    post-run: playbooks/openstack-doc-build/post
    required-projects:
      - name: openstack/requirements
    roles:
      - zuul: openstack-infra/zuul-jobs
    vars:
      tox_environment:
        UPPER_CONSTRAINTS_FILE: "{{ ansible_user_dir }}/src/git.openstack.org/openstack/requirements/upper-constraints.txt"
      tox_envlist: venv
      tox_extra_args: -vv python setup.py build_sphinx

- job:
    name: tox-py35-on-zuul
    parent: tox-py35
    description: |
      Run zuul's py35 unittests on patches to zuul-jobs
    vars:
      zuul_work_dir: "src/git.openstack.org/openstack-infra/zuul"
    required-projects:
      - name: openstack-infra/zuul
        override-branch: feature/zuulv3

- job:
    name: tox-py35-constraints
    parent: tox-py35
    description: |
      Run zuul's tox 'py35' job but with OpenStack requirements constraints
    required-projects:
      - name: openstack/requirements
    vars:
      tox_environment:
        UPPER_CONSTRAINTS_FILE: "{{ ansible_user_dir }}/src/git.openstack.org/openstack/requirements/upper-constraints.txt"

- job:
    name: publish-openstack-python-tarball
    parent: publish-openstack-artifacts
    description: |
      Publish the results of the tox-tarball job to tarballs.openstack.org.
    pre-run: playbooks/python-tarball/pre
    run: playbooks/python-tarball/run
    post-run: playbooks/python-tarball/post

- job:
    name: build-openstack-python-tarball
    parent: python-sdist
    description: |
      Build a tarball using tox but do not upload it anywhere.
    pre-run: playbooks/python-tarball/pre
    run: playbooks/python-tarball/run

- job:
    name: announce-release
    description:
      Send a release announcement after publishing a project
    pre-run: playbooks/release/pre
    run: playbooks/release/announce
    required-projects:
      - openstack-infra/release-tools

- project-template:
    name: publish-to-pypi
    description: |
      Publish a Python package to PyPI, then send release announcement
      emails and propose updates to upper-constraints as needed.
    pre-release:
      jobs:
        - publish-openstack-python-tarball
        - announce-release:
            dependencies:
              - publish-openstack-python-tarball
        - propose-update-constraints:
            dependencies:
              - publish-openstack-python-tarball
    release:
      jobs:
        - publish-openstack-python-tarball
        - announce-release:
            dependencies:
              - publish-openstack-python-tarball
        - propose-update-constraints:
            dependencies:
              - publish-openstack-python-tarball

- project-template:
    name: publish-to-pypi-quietly
    description: |
      Publish a Python package to PyPI but do not send announce emails or
      propose upper-constraints updates.
    pre-release:
      jobs:
        - publish-openstack-python-tarball
    release:
      jobs:
        - publish-openstack-python-tarball

- project-template:
    name: openstack-python-jobs
    check:
      jobs:
        - openstack-doc-build
        - tox-pep8
        - tox-py27
    gate:
      jobs:
        - openstack-doc-build
        - tox-pep8
        - tox-py27
    post:
      jobs:
        - publish-openstack-python-branch-tarball

- project-template:
    name: openstack-python35-jobs
    check:
      jobs:
        - tox-py35
    gate:
      jobs:
        - tox-py35

- project-template:
     name: docs-on-readthedocs
     post:
       jobs:
         - trigger-readthedocs
     pre-release:
       jobs:
         - trigger-readthedocs
     release:
       jobs:
         - trigger-readthedocs

- project:
    name: openstack-infra/openstack-zuul-jobs
    check:
      jobs:
        - openstack-doc-build
        - tox-linters
    gate:
      jobs:
        - openstack-doc-build
        - tox-linters
